<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史人物与事件时间轴</title>
    <link href="https://cdn.jsdelivr.net/npm/antd@5.11.0/dist/reset.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .title {
            text-align: center;
            margin-bottom: 30px;
            color: #1a1a1a;
        }
        
        .visualization-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .lifespan-chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        #lifespanChart {
            width: 100%;
            height: 500px;
        }
        
        .age-chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        #ageChart {
            width: 100%;
            height: 400px;
        }
        
        .controls-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        .year-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        #yearSlider {
            width: 600px;
        }
        
        .current-year {
            font-size: 24px;
            font-weight: bold;
            color: #1890ff;
            min-width: 100px;
            text-align: center;
        }
        
        .events-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        .events-section h3 {
            margin-bottom: 15px;
            color: #1a1a1a;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        
        th {
            background-color: #fafafa;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        tr:hover {
            background-color: #fafafa;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #ff4d4f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">历史人物与事件时间轴</h1>
        
        <div class="visualization-section">
            <!-- 人物生涯时间轴图表 -->
            <div class="lifespan-chart-container">
                <h3 style="text-align: center; margin-bottom: 20px;">人物生命周期时间轴</h3>
                <div id="lifespanChart"></div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #5470c6;"></div>
                        <span>生命周期</span>
                    </div>
                </div>
            </div>
            
            <!-- 当前年龄柱状图 -->
            <div class="age-chart-container">
                <h3 style="text-align: center; margin-bottom: 20px;">当前人物年龄分布</h3>
                <div id="ageChart"></div>
            </div>
        </div>
        
        <!-- 年份控制器 -->
        <div class="controls-section">
            <div class="year-control">
                <span>公元前500年</span>
                <input type="range" id="yearSlider" min="-500" max="2000" value="0" step="10">
                <span>2000年</span>
                <div class="current-year" id="currentYearDisplay">0年</div>
            </div>
        </div>
        
        <!-- 事件表格 -->
        <div class="events-section">
            <h3 id="eventsTitle">0年历史事件</h3>
            <table id="eventsTable">
                <thead>
                    <tr>
                        <th>事件名称</th>
                        <th>分类</th>
                        <th>开始日期</th>
                        <th>结束日期</th>
                        <th>描述</th>
                    </tr>
                </thead>
                <tbody id="eventsTableBody">
                    <tr>
                        <td colspan="5" class="loading">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 初始化变量
        let lifespanChart = null;
        let ageChart = null;
        let currentYear = 0;
        let historicalPersons = [];
        let historicalEvents = {};
        let isLoading = true;

        // 从数据库获取数据
        async function fetchData() {
            try {
                console.log('开始获取数据...');
                
                // 模拟数据获取 - 实际应用中需要替换为真实API调用
                // 这里使用从数据库结构转换的模拟数据
                await new Promise(resolve => setTimeout(resolve, 1000)); // 模拟网络延迟
                
                // 模拟从timeline_persons表获取的数据
                historicalPersons = [
                    { id: 1, name: '孔子', birthYear: -551, deathYear: -479, bio: '春秋时期著名思想家、教育家，儒家学派创始人' },
                    { id: 2, name: '孟子', birthYear: -372, deathYear: -289, bio: '战国时期思想家，儒家学派代表人物，被誉为"亚圣"' },
                    { id: 3, name: '秦始皇', birthYear: -259, deathYear: -210, bio: '中国历史上第一位皇帝，统一六国，建立中央集权制度' },
                    { id: 4, name: '汉武帝', birthYear: -156, deathYear: -87, bio: '西汉皇帝，推行推恩令，北击匈奴，开辟丝绸之路' },
                    { id: 5, name: '司马迁', birthYear: -145, deathYear: -86, bio: '西汉史学家、文学家，著有《史记》' },
                    { id: 6, name: '光武帝', birthYear: -5, deathYear: 57, bio: '东汉开国皇帝，恢复汉室，开创光武中兴' },
                    { id: 7, name: '曹操', birthYear: 155, deathYear: 220, bio: '东汉末年政治家、军事家、文学家，曹魏奠基者' },
                    { id: 8, name: '诸葛亮', birthYear: 181, deathYear: 234, bio: '三国时期蜀汉丞相，杰出的政治家、军事家、发明家' },
                    { id: 9, name: '王羲之', birthYear: 303, deathYear: 361, bio: '东晋书法家，被誉为"书圣"，代表作《兰亭序》' },
                    { id: 10, name: '唐太宗', birthYear: 598, deathYear: 649, bio: '唐朝第二位皇帝，开创贞观之治' },
                    { id: 11, name: '武则天', birthYear: 624, deathYear: 705, bio: '中国历史上唯一正统女皇帝' },
                    { id: 12, name: '李白', birthYear: 701, deathYear: 762, bio: '唐代伟大诗人，被誉为"诗仙"' },
                    { id: 13, name: '杜甫', birthYear: 712, deathYear: 770, bio: '唐代伟大诗人，被誉为"诗圣"' }
                ];
                
                // 模拟从timeline_events表获取的数据
                const eventsData = [
                    { event_name: '孔子出生', start_date: '-551-01-01', description: '孔子诞生于鲁国陬邑（今山东曲阜）。', event_category: '人物生平' },
                    { event_name: '孔子逝世', start_date: '-479-01-01', description: '孔子逝世，享年73岁。', event_category: '人物生平' },
                    { event_name: '孟子出生', start_date: '-372-01-01', description: '孟子出生于邹国（今山东邹城）。', event_category: '人物生平' },
                    { event_name: '孟子见梁惠王', start_date: '-320-01-01', description: '孟子拜见梁惠王，阐述仁政思想。', event_category: '重要事件' },
                    { event_name: '孟子逝世', start_date: '-289-01-01', description: '孟子逝世，享年84岁。', event_category: '人物生平' },
                    { event_name: '秦始皇出生', start_date: '-259-01-01', description: '秦始皇嬴政出生于赵国邯郸。', event_category: '人物生平' },
                    { event_name: '秦始皇即位', start_date: '-247-01-01', description: '13岁的嬴政即位为秦王。', event_category: '政治事件' },
                    { event_name: '秦统一六国', start_date: '-221-01-01', end_date: '-221-12-31', description: '秦始皇灭掉六国，建立中国历史上第一个中央集权制国家。', event_category: '政治事件' },
                    { event_name: '秦始皇逝世', start_date: '-210-01-01', description: '秦始皇在东巡途中病逝，享年50岁。', event_category: '人物生平' },
                    { event_name: '汉武帝即位', start_date: '-141-01-01', description: '汉武帝即位，开始了长达54年的统治。', event_category: '政治事件' },
                    { event_name: '张骞出使西域', start_date: '-138-01-01', end_date: '-126-01-01', description: '汉武帝派遣张骞出使西域，开辟丝绸之路。', event_category: '外交事件' },
                    { event_name: '玄武门之变', start_date: '626-07-02', description: '李世民发动玄武门之变，不久后继位为唐太宗。', event_category: '政治事件' },
                    { event_name: '武则天称帝', start_date: '690-10-16', description: '武则天称帝，改国号为周，成为中国历史上唯一正统女皇帝。', event_category: '政治事件' },
                    { event_name: '李杜相识', start_date: '744-01-01', description: '杜甫与李白在洛阳相识，结下深厚友谊。', event_category: '文化事件' }
                ];
                
                // 转换事件数据为按年份索引的格式
                historicalEvents = {};
                eventsData.forEach(event => {
                    // 从日期字符串中提取年份
                    const year = parseInt(event.start_date.split('-')[0]);
                    if (!historicalEvents[year]) {
                        historicalEvents[year] = [];
                    }
                    historicalEvents[year].push(event);
                });
                
                console.log('数据获取完成:', { historicalPersons, historicalEvents });
                isLoading = false;
                return true;
            } catch (error) {
                console.error('数据获取失败:', error);
                document.getElementById('eventsTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="error">数据加载失败，请稍后重试</td>
                    </tr>
                `;
                isLoading = false;
                return false;
            }
        }

        // 计算指定年份人物的年龄
        function calculateAge(person, year) {
            if (year < person.birthYear || year > person.deathYear) {
                return null; // 不在在世年份
            }
            return year - person.birthYear;
        }

        // 获取指定年份所有在世人物的年龄
        function getAlivePersonsAges(year) {
            return historicalPersons
                .map(person => ({
                    name: person.name,
                    age: calculateAge(person, year),
                    person: person
                }))
                .filter(item => item.age !== null);
        }

        // 获取指定年份的事件
        function getEventsByYear(year) {
            return historicalEvents[year] || [];
        }

        // 初始化生涯时间轴图表
        function initLifespanChart() {
            lifespanChart = echarts.init(document.getElementById('lifespanChart'));
            updateLifespanChart(currentYear);
        }

        // 更新生涯时间轴图表
        function updateLifespanChart(selectedYear) {
            if (isLoading || historicalPersons.length === 0) return;
            
            const series = [];
            
            // 为每个人物创建生命周期条形图
            historicalPersons.forEach((person, index) => {
                // 生命周期条形图
                series.push({
                    name: person.name + '-生命周期',
                    type: 'custom',
                    renderItem: function(params, api) {
                        const categoryIndex = api.value(0);
                        const start = api.coord([api.value(1), categoryIndex]);
                        const end = api.coord([api.value(2), categoryIndex]);
                        const height = api.size([0, 1])[1] * 0.6;
                        
                        const rectShape = echarts.graphic.clipRectByRect({
                            x: start[0],
                            y: start[1] - height / 2,
                            width: end[0] - start[0],
                            height: height
                        }, {
                            x: params.coordSys.x,
                            y: params.coordSys.y,
                            width: params.coordSys.width,
                            height: params.coordSys.height
                        });
                        
                        return rectShape && {
                            type: 'rect',
                            transition: ['shape'],
                            shape: rectShape,
                            style: {
                                fill: '#5470c6',
                                opacity: 0.6
                            }
                        };
                    },
                    itemStyle: {
                        color: '#5470c6'
                    },
                    encode: {
                        x: [1, 2],
                        y: 0
                    },
                    data: [[index, person.birthYear, person.deathYear]],
                    silent: true
                });
            });
            
            // 添加当前年份指示线
            series.push({
                name: '当前年份',
                type: 'line',
                data: historicalPersons.map((_, index) => [selectedYear, index]),
                lineStyle: {
                    color: '#ee6666',
                    width: 2,
                    type: 'dashed'
                },
                symbol: 'circle',
                symbolSize: 6,
                itemStyle: {
                    color: '#ee6666'
                },
                encode: {
                    x: 0,
                    y: 1
                },
                tooltip: {
                    formatter: function(params) {
                        const person = historicalPersons[params.value[1]];
                        const age = calculateAge(person, selectedYear);
                        if (age !== null) {
                            return `${person.name}<br/>${selectedYear}年时年龄：${age}岁`;
                        } else {
                            return `${person.name}<br/>${selectedYear}年时不在世`;
                        }
                    }
                }
            });
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    top: '10%',
                    bottom: '10%'
                },
                xAxis: {
                    type: 'value',
                    name: '年份',
                    min: -600,
                    max: 1550,
                    axisLabel: {
                        formatter: function(value) {
                            return value < 0 ? `${Math.abs(value)} BCE` : `${value} CE`;
                        }
                    }
                },
                yAxis: {
                    type: 'category',
                    data: historicalPersons.map(person => person.name),
                    axisLabel: {
                        fontSize: 11
                    }
                },
                series: series
            };
            
            lifespanChart.setOption(option);
        }

        // 初始化年龄分布图
        function initAgeChart() {
            ageChart = echarts.init(document.getElementById('ageChart'));
            updateAgeChart(currentYear);
        }

        // 更新年龄分布图
        function updateAgeChart(year) {
            if (isLoading || historicalPersons.length === 0) return;
            
            const ageData = getAlivePersonsAges(year);
            
            const option = {
                title: {
                    text: `${year}年人物年龄分布`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        const data = params[0];
                        return `${data.name}<br/>年龄: ${data.value}岁`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ageData.map(item => item.name),
                    axisLabel: {
                        interval: 0,
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '年龄（岁）',
                    min: 0
                },
                series: [{
                    name: '年龄',
                    type: 'bar',
                    data: ageData.map(item => item.age),
                    itemStyle: {
                        color: function(params) {
                            const age = params.value;
                            // 根据年龄设置不同的颜色
                            if (age < 20) return '#91cc75';
                            else if (age < 40) return '#fac858';
                            else if (age < 60) return '#ee6666';
                            else return '#73c0de';
                        }
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}岁'
                    }
                }]
            };
            
            ageChart.setOption(option);
        }

        // 更新事件表格
        function updateEventsTable(year) {
            if (isLoading) return;
            
            const events = getEventsByYear(year);
            const tableBody = document.getElementById('eventsTableBody');
            const eventsTitle = document.getElementById('eventsTitle');
            
            eventsTitle.textContent = `${year}年历史事件`;
            tableBody.innerHTML = '';
            
            if (events.length > 0) {
                events.forEach(event => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${event.event_name}</td>
                        <td>${event.event_category || '-'}</td>
                        <td>${event.start_date}</td>
                        <td>${event.end_date || '-'}</td>
                        <td>${event.description}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" style="text-align: center;">该年份暂无记录的事件</td>
                `;
                tableBody.appendChild(row);
            }
        }

        // 初始化年份滑块
        function initYearSlider() {
            const yearSlider = document.getElementById('yearSlider');
            const yearDisplay = document.getElementById('currentYearDisplay');
            
            yearSlider.value = currentYear;
            yearDisplay.textContent = `${currentYear}年`;
            
            yearSlider.addEventListener('input', function() {
                currentYear = parseInt(this.value);
                yearDisplay.textContent = `${currentYear}年`;
                
                // 更新图表
                updateLifespanChart(currentYear);
                updateAgeChart(currentYear);
                updateEventsTable(currentYear);
            });
        }

        // 初始化页面
        async function init() {
            // 先获取数据
            const dataLoaded = await fetchData();
            
            if (dataLoaded) {
                // 初始化各组件
                initYearSlider();
                initLifespanChart();
                initAgeChart();
                updateEventsTable(currentYear);
            }
            
            // 响应式处理
            window.addEventListener('resize', function() {
                if (lifespanChart) lifespanChart.resize();
                if (ageChart) ageChart.resize();
            });
        }

        // 页面加载完成后初始化
        window.onload = init;
    </script>
</body>
</html>