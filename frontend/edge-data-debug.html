<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>关系数据调试</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { color: #1890ff; margin-bottom: 20px; }
    .section { margin-bottom: 30px; }
    button { padding: 8px 16px; background-color: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #40a9ff; }
    pre { background-color: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    .theme-selector { margin-bottom: 10px; }
    .theme-selector select, .theme-selector input { padding: 5px; margin-right: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>关系数据调试工具</h1>
    
    <div class="section">
      <div class="theme-selector">
        <label for="themeId">主题ID:</label>
        <input type="text" id="themeId" placeholder="请输入主题ID">
        <button id="fetchEdgeDataBtn">获取关系数据</button>
      </div>
      <h2>关系数据详情:</h2>
      <pre id="edgeDataDisplay"></pre>
    </div>
    
    <div class="section">
      <h2>所有主题:</h2>
      <pre id="themesDisplay"></pre>
      <button id="fetchThemesBtn">获取所有主题</button>
    </div>
    
    <div class="section">
      <h2>表格列定义参考:</h2>
      <pre id="columnsRef">[
  { title: '关系ID', dataIndex: 'id', key: 'id' },
  { title: '关系类型', dataIndex: 'relation', key: 'relation' },
  { title: '源节点', dataIndex: 'source_node_name', key: 'source_node_name' },
  { title: '目标节点', dataIndex: 'target_node_name', key: 'target_node_name' },
  { title: '颜色', key: 'color', slots: { customRender: 'edgeColor' } },
  { title: '宽度', dataIndex: 'width', key: 'width' },
  { title: '是否虚线', dataIndex: 'dashed', key: 'dashed', slots: { customRender: 'edgeDashed' } },
  { title: '操作', key: 'operation', slots: { customRender: 'operation' } }
]</pre>
    </div>
  </div>
  
  <script>
    // 获取DOM元素
    const themeIdInput = document.getElementById('themeId');
    const fetchEdgeDataBtn = document.getElementById('fetchEdgeDataBtn');
    const edgeDataDisplay = document.getElementById('edgeDataDisplay');
    const fetchThemesBtn = document.getElementById('fetchThemesBtn');
    const themesDisplay = document.getElementById('themesDisplay');
    
    // 基础URL
    const baseUrl = 'http://localhost:8080/api';
    
    // 获取关系数据
    fetchEdgeDataBtn.addEventListener('click', async () => {
      const themeId = themeIdInput.value.trim();
      if (!themeId) {
        edgeDataDisplay.textContent = '请输入有效的主题ID';
        return;
      }
      
      try {
        edgeDataDisplay.textContent = '正在获取数据...';
        const response = await axios.get(`${baseUrl}/edges/theme/${themeId}`);
        
        // 格式化数据以便查看
        const data = response.data;
        let displayText = `状态码: ${response.status}\n`;
        displayText += `数据类型: ${Array.isArray(data) ? '数组' : '对象'}\n`;
        displayText += `数据长度: ${Array.isArray(data) ? data.length : 'N/A'}\n\n`;
        displayText += '完整数据:\n';
        displayText += JSON.stringify(data, null, 2);
        
        // 如果有数据，显示第一个元素的字段
        if (Array.isArray(data) && data.length > 0) {
          displayText += '\n\n第一个元素的可用字段:';
          displayText += Object.keys(data[0]).join(', ');
        }
        
        edgeDataDisplay.textContent = displayText;
        
        // 同时尝试获取节点数据进行关联检查
        await fetchNodesData(themeId);
      } catch (error) {
        edgeDataDisplay.textContent = `获取数据失败: ${error.message}\n${JSON.stringify(error.response?.data || {}, null, 2)}`;
      }
    });
    
    // 获取所有主题
    fetchThemesBtn.addEventListener('click', async () => {
      try {
        themesDisplay.textContent = '正在获取主题...';
        const response = await axios.get(`${baseUrl}/themes`);
        const data = response.data;
        themesDisplay.textContent = JSON.stringify(data, null, 2);
        
        // 如果有主题，自动填充第一个主题的ID
        if (Array.isArray(data) && data.length > 0 && !themeIdInput.value) {
          themeIdInput.value = data[0].id;
        }
      } catch (error) {
        themesDisplay.textContent = `获取主题失败: ${error.message}`;
      }
    });
    
    // 获取节点数据用于关联检查
    async function fetchNodesData(themeId) {
      try {
        const response = await axios.get(`${baseUrl}/nodes/theme/${themeId}`);
        const nodes = response.data;
        
        if (Array.isArray(nodes) && nodes.length > 0) {
          edgeDataDisplay.textContent += '\n\n\n关联的节点数据预览（前5个）:\n';
          edgeDataDisplay.textContent += JSON.stringify(nodes.slice(0, 5), null, 2);
        }
      } catch (error) {
        edgeDataDisplay.textContent += '\n\n获取节点数据失败，不影响主要调试。';
      }
    }
    
    // 页面加载时自动获取主题列表
    window.addEventListener('load', () => {
      fetchThemesBtn.click();
    });
  </script>
</body>
</html>