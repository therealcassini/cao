<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èŠ‚ç‚¹ä¸»é¢˜åŒ¹é…æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      color: #1890ff;
    }
    button {
      padding: 8px 16px;
      background-color: #1890ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background-color: #40a9ff;
    }
    pre {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
    }
    .section {
      margin-bottom: 20px;
    }
    .error {
      color: #ff4d4f;
    }
    .success {
      color: #52c41a;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #e8e8e8;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #fafafa;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <h1>èŠ‚ç‚¹ä¸»é¢˜åŒ¹é…æµ‹è¯•</h1>
  
  <div class="section">
    <button id="loadData">åŠ è½½æ•°æ®å¹¶æµ‹è¯•</button>
    <button id="clear">æ¸…ç©ºç»“æœ</button>
  </div>
  
  <div class="section">
    <h2>æµ‹è¯•ç»“æœ</h2>
    <div id="resultSummary"></div>
  </div>
  
  <div class="section">
    <h2>ä¸»é¢˜æ•°æ®</h2>
    <pre id="themesData">(ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½æ•°æ®)</pre>
  </div>
  
  <div class="section">
    <h2>èŠ‚ç‚¹æ•°æ®</h2>
    <pre id="nodesData">(ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½æ•°æ®)</pre>
  </div>
  
  <div class="section">
    <h2>èŠ‚ç‚¹ä¸»é¢˜åŒ¹é…æƒ…å†µ</h2>
    <table id="matchingTable">
      <thead>
        <tr>
          <th>èŠ‚ç‚¹ID</th>
          <th>èŠ‚ç‚¹åç§°</th>
          <th>ä¸»é¢˜ID</th>
          <th>åŒ¹é…åˆ°çš„ä¸»é¢˜åç§°</th>
          <th>åŒ¹é…çŠ¶æ€</th>
        </tr>
      </thead>
      <tbody id="matchingTableBody">
        <tr><td colspan="5" style="text-align: center;">(ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½æ•°æ®)</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // DOMå…ƒç´ 
    const loadDataBtn = document.getElementById('loadData');
    const clearBtn = document.getElementById('clear');
    const themesDataEl = document.getElementById('themesData');
    const nodesDataEl = document.getElementById('nodesData');
    const resultSummaryEl = document.getElementById('resultSummary');
    const matchingTableBodyEl = document.getElementById('matchingTableBody');
    
    // åŠ è½½æ•°æ®å¹¶æµ‹è¯•
    loadDataBtn.addEventListener('click', async () => {
      try {
        // è®¾ç½®æŒ‰é’®çŠ¶æ€
        loadDataBtn.disabled = true;
        loadDataBtn.textContent = 'åŠ è½½ä¸­...';
        
        // åŠ è½½ä¸»é¢˜æ•°æ®
        themesDataEl.textContent = 'åŠ è½½ä¸»é¢˜æ•°æ®...';
        const themesResponse = await fetch('/api/themes');
        if (!themesResponse.ok) {
          throw new Error(`åŠ è½½ä¸»é¢˜æ•°æ®å¤±è´¥: ${themesResponse.status}`);
        }
        const themes = await themesResponse.json();
        themesDataEl.textContent = JSON.stringify(themes, null, 2);
        
        // åŠ è½½èŠ‚ç‚¹æ•°æ®
        nodesDataEl.textContent = 'åŠ è½½èŠ‚ç‚¹æ•°æ®...';
        const nodesResponse = await fetch('/api/nodes');
        if (!nodesResponse.ok) {
          throw new Error(`åŠ è½½èŠ‚ç‚¹æ•°æ®å¤±è´¥: ${nodesResponse.status}`);
        }
        const nodes = await nodesResponse.json();
        nodesDataEl.textContent = JSON.stringify(nodes, null, 2);
        
        // æ‰§è¡Œä¸»é¢˜åŒ¹é…æµ‹è¯•
        const testResult = testThemeMatching(nodes, themes);
        
        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        displayTestResult(testResult);
        
      } catch (error) {
        console.error('æµ‹è¯•å¤±è´¥:', error);
        resultSummaryEl.innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        loadDataBtn.disabled = false;
        loadDataBtn.textContent = 'åŠ è½½æ•°æ®å¹¶æµ‹è¯•';
      }
    });
    
    // æ¸…ç©ºç»“æœ
    clearBtn.addEventListener('click', () => {
      themesDataEl.textContent = '(ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½æ•°æ®)';
      nodesDataEl.textContent = '(ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½æ•°æ®)';
      resultSummaryEl.innerHTML = '';
      matchingTableBodyEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">(ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½æ•°æ®)</td></tr>';
    });
    
    // æ‰§è¡Œä¸»é¢˜åŒ¹é…æµ‹è¯•
    function testThemeMatching(nodes, themes) {
      const result = {
        totalNodes: nodes.length,
        matchedNodes: 0,
        unmatchedNodes: 0,
        matchingDetails: []
      };
      
      nodes.forEach(node => {
        // å°è¯•ä»ä¸åŒå­—æ®µè·å–themeId
        let themeId = node.themeId || node.theme_id || node.theme || '';
        
        // æ‰§è¡ŒåŒ¹é…ï¼ˆä½¿ç”¨ä¸GraphManager.vueä¸­ç›¸åŒçš„é€»è¾‘ï¼‰
        const theme = themes.find(t => String(t.id) === String(themeId));
        
        // è®°å½•åŒ¹é…ç»“æœ
        const detail = {
          nodeId: node.id,
          nodeName: node.name,
          themeId: themeId,
          themeName: theme ? theme.name : null,
          isMatched: !!theme
        };
        
        result.matchingDetails.push(detail);
        
        // æ›´æ–°ç»Ÿè®¡
        if (theme) {
          result.matchedNodes++;
        } else {
          result.unmatchedNodes++;
        }
      });
      
      return result;
    }
    
    // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
    function displayTestResult(result) {
      // æ˜¾ç¤ºæ‘˜è¦
      const matchRate = (result.matchedNodes / result.totalNodes * 100).toFixed(2);
      resultSummaryEl.innerHTML = `
        <div>æ€»èŠ‚ç‚¹æ•°: ${result.totalNodes}</div>
        <div>åŒ¹é…æˆåŠŸçš„èŠ‚ç‚¹æ•°: <span class="success">${result.matchedNodes}</span></div>
        <div>åŒ¹é…å¤±è´¥çš„èŠ‚ç‚¹æ•°: <span class="error">${result.unmatchedNodes}</span></div>
        <div>åŒ¹é…æˆåŠŸç‡: ${matchRate}%</div>
      `;
      
      // æ˜¾ç¤ºè¯¦ç»†åŒ¹é…æƒ…å†µè¡¨æ ¼
      matchingTableBodyEl.innerHTML = '';
      
      result.matchingDetails.forEach(detail => {
        const row = document.createElement('tr');
        
        // ä¸ºåŒ¹é…å¤±è´¥çš„è¡Œæ·»åŠ ç‰¹æ®Šæ ·å¼
        if (!detail.isMatched) {
          row.style.backgroundColor = '#fff2f0';
        }
        
        row.innerHTML = `
          <td>${detail.nodeId}</td>
          <td>${detail.nodeName}</td>
          <td>${detail.themeId || '(æ— )'}</td>
          <td>${detail.themeName || '(æœªåŒ¹é…)'}</td>
          <td>${detail.isMatched ? '<span class="success">æˆåŠŸ</span>' : '<span class="error">å¤±è´¥</span>'}</td>
        `;
        
        matchingTableBodyEl.appendChild(row);
      });
      
      // å¦‚æœæ‰€æœ‰èŠ‚ç‚¹éƒ½åŒ¹é…æˆåŠŸï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      if (result.unmatchedNodes === 0) {
        resultSummaryEl.innerHTML += '<div class="success">ğŸ‰ æ­å–œï¼æ‰€æœ‰èŠ‚ç‚¹éƒ½æˆåŠŸåŒ¹é…åˆ°äº†ä¸»é¢˜åç§°ï¼</div>';
      } else {
        // å¦åˆ™æ˜¾ç¤ºæç¤ºä¿¡æ¯
        resultSummaryEl.innerHTML += `
          <div class="error">
            âš ï¸ æœ‰${result.unmatchedNodes}ä¸ªèŠ‚ç‚¹æœªèƒ½åŒ¹é…åˆ°ä¸»é¢˜ã€‚
            è¯·æ£€æŸ¥èŠ‚ç‚¹çš„themeIdæ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠå¯¹åº”çš„ä¸»é¢˜æ˜¯å¦å­˜åœ¨ã€‚
          </div>
        `;
      }
    }
  </script>
</body>
</html>